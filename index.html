<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Pro | Hasitha</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        :root[data-theme="light"] {
            --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --sub: #64748b;
            --border: #e2e8f0; --primary: #2563eb; --income: #10b981; --expense: #ef4444; --accent: #eff6ff;
        }
        :root[data-theme="dark"] {
            --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --sub: #94a3b8;
            --border: #334155; --primary: #3b82f6; --income: #34d399; --expense: #f87171; --accent: #1e293b;
        }

        * { box-sizing: border-box; transition: 0.2s; font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; }

        .app-container { width: 100%; max-width: 500px; min-height: 100vh; padding-bottom: 120px; position: relative; }
        
        .page { display: none; padding: 20px; animation: slideUp 0.3s ease; }
        .page.active { display: block; }
        .card { background: var(--card); border-radius: 24px; padding: 20px; border: 1px solid var(--border); margin-bottom: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        /* Typography */
        h2 { font-size: 24px; font-weight: 800; margin: 0; }
        h3 { font-size: 18px; margin: 0 0 15px 0; }
        .label-sm { font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--sub); display: block; margin-bottom: 6px; }

        /* Forms */
        .f-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .full { grid-column: span 2; }
        input, select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg); color: var(--text); font-size: 14px; outline: none; }
        input:focus { border-color: var(--primary); }

        /* Buttons */
        .btn-p { width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .btn-s { background: var(--accent); color: var(--primary); border: none; padding: 8px 12px; border-radius: 10px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .btn-del { background: none; border: none; color: var(--expense); font-size: 18px; cursor: pointer; padding: 5px; }

        /* Navigation */
        .nav-bar { position: fixed; bottom: 20px; width: 92%; max-width: 460px; background: var(--card); border: 1px solid var(--border); border-radius: 28px; display: flex; padding: 10px; box-shadow: 0 12px 30px rgba(0,0,0,0.2); backdrop-filter: blur(10px); z-index: 1000; }
        .nav-item { flex: 1; text-align: center; color: var(--sub); font-size: 10px; font-weight: 600; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { display: block; font-size: 20px; font-style: normal; margin-bottom: 2px; }

        /* Dashboard specific */
        .hero { background: var(--primary); color: white; border-radius: 28px; padding: 30px; text-align: center; margin-bottom: 20px; position: relative; overflow: hidden; }
        .pie-box { width: 120px; height: 120px; border-radius: 50%; margin: 15px auto; position: relative; }
        .live-pill { font-size: 11px; font-weight: 800; padding: 4px 12px; border-radius: 20px; float: right; }

        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 12px 25px; border-radius: 12px; z-index: 9999; display: none; font-size: 13px; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="toast"></div>

<div class="app-container">
    <div style="padding: 25px 20px 10px 20px; display: flex; justify-content: space-between; align-items: center;">
        <div><small style="color:var(--sub); font-weight:600;">Finance Tracker</small><h2 id="vTitle">Overview</h2></div>
        <div onclick="toggleTheme()" style="cursor:pointer; font-size: 22px;">üåì</div>
    </div>

    <section id="dash" class="page active">
        <div class="hero">
            <small style="opacity:0.8; letter-spacing: 1px;">TOTAL NET ASSETS</small>
            <h1 id="netVal" style="font-size: 40px; margin: 10px 0;">0.00</h1>
            <div id="pieChart" class="pie-box"></div>
            <div id="dashStats" style="font-size:12px; opacity: 0.9;">Analyzing data...</div>
        </div>
        <div class="f-grid">
            <div class="card" style="margin:0; text-align:center;"><label class="label-sm">Main</label><div id="vMain" style="font-weight:800;">0</div></div>
            <div class="card" style="margin:0; text-align:center;"><label class="label-sm">Savings</label><div id="vSave" style="font-weight:800;">0</div></div>
        </div>
        <div class="card" style="margin-top:16px;">
            <label class="label-sm">Recent Transactions</label>
            <div id="recentList"></div>
        </div>
    </section>

    <section id="entry" class="page">
        <div class="card">
            <span id="eLive" class="live-pill">Select Account</span>
            <h3>Add Transaction</h3>
            <div class="f-grid">
                <div class="full"><label class="label-sm">Account</label><select id="eAcc" onchange="updateLive('eAcc','eLive')"><option>Main</option><option>Saving</option><option>Credit Card</option></select></div>
                <div><label class="label-sm">Type</label><select id="eType" onchange="loadCats()"><option>Expense</option><option>Income</option></select></div>
                <div><label class="label-sm">Date</label><input type="date" id="eDate"></div>
                <div><label class="label-sm">Category</label><select id="eCat" onchange="loadSubs()"></select></div>
                <div><label class="label-sm">Subcategory</label><select id="eSub"></select></div>
                <div class="full" id="vehBox" style="display:none"><label class="label-sm">Vehicle</label><select id="eVeh"></select></div>
                <div class="full"><label class="label-sm">Amount (LKR)</label><input type="number" id="eAmt" placeholder="0.00" style="font-size:24px; font-weight:800;"></div>
                <div class="full"><label class="label-sm">Remark</label><input type="text" id="eRem" placeholder="Optional details..."></div>
            </div>
            <button class="btn-p" onclick="saveTx()">Confirm Entry</button>
        </div>
    </section>

    <section id="transfer" class="page">
        <div class="card">
            <span id="tLive" class="live-pill">Select Source</span>
            <h3>Transfer Funds</h3>
            <div class="f-grid">
                <div class="full"><label class="label-sm">Date</label><input type="date" id="tDate"></div>
                <div><label class="label-sm">From</label><select id="tFrom" onchange="updateLive('tFrom','tLive')"><option>Main</option><option>Saving</option><option>Crypto</option></select></div>
                <div><label class="label-sm">To</label><select id="tTo"><option>Saving</option><option>Main</option><option>Crypto</option></select></div>
                <div class="full"><label class="label-sm">Amount</label><input type="number" id="tAmt" placeholder="0.00" style="text-align:center; font-size:24px; font-weight:800; color:var(--income)"></div>
            </div>
            <button class="btn-p" onclick="doTransfer()">Execute Transfer</button>
        </div>
    </section>

    <section id="stats" class="page">
        <div class="card" style="background:var(--primary); color:white;">
            <label class="label-sm" style="color:white; opacity:0.8;">Monthly Forecast</label>
            <div id="forecastBox" style="margin-top:10px;">Syncing engine...</div>
        </div>
        <div class="card">
            <h3>History & Export</h3>
            <div class="f-grid" style="margin-bottom:15px;">
                <select id="fMonth" onchange="runReport()"><option value="">All Time</option><option value="-01-">January</option><option value="-02-">February</option></select>
                <button onclick="exportCSV()" class="btn-s">Download CSV</button>
            </div>
            <div id="reportList"></div>
        </div>
    </section>

    <section id="setup" class="page">
        <div class="card">
            <h3>Baselines</h3>
            <div class="f-grid">
                <div><label class="label-sm">Main</label><input type="number" id="cMain"></div>
                <div><label class="label-sm">Saving</label><input type="number" id="cSave"></div>
                <div><label class="label-sm">CC Limit</label><input type="number" id="cCCL"></div>
                <div><label class="label-sm">CC Spent</label><input type="number" id="cCCS"></div>
                <div><label class="label-sm">USDT Rate</label><input type="number" id="cRate"></div>
                <div><label class="label-sm">Crypto (Qty)</label><input type="number" id="cCry"></div>
            </div>
            <button class="btn-p" style="background:var(--text); color:var(--card);" onclick="saveConf()">Sync Baselines</button>
        </div>
        <div class="card">
            <h3>Vehicles</h3>
            <div id="vehicleList"></div>
            <div style="background:var(--bg); padding:15px; border-radius:15px; margin-top:10px;">
                <input type="text" id="vReg" placeholder="Reg: BDD 0471">
                <input type="text" id="vMake" placeholder="Model: Honda Hornet" style="margin-top:8px;">
                <button class="btn-p" onclick="addVehicle()">Add Vehicle</button>
            </div>
        </div>
    </section>

    <div class="nav-bar">
        <div class="nav-item active" onclick="nav('dash', this)"><i>üè†</i>Dash</div>
        <div class="nav-item" onclick="nav('entry', this)"><i>‚ûï</i>Entry</div>
        <div class="nav-item" onclick="nav('transfer', this)"><i>üîÑ</i>Move</div>
        <div class="nav-item" onclick="nav('stats', this)"><i>üìä</i>Stats</div>
        <div class="nav-item" onclick="nav('setup', this)"><i>‚öôÔ∏è</i>Setup</div>
    </div>
</div>

<script>
    const supa = supabase.createClient('https://hskramdwzubiteautnkw.supabase.co', 'sb_publishable_cPy4XEg_f2eQEo0N-3UMyg_qX4nDtF8');

    let txs = [], conf = {}, vehs = [], bal = {};

    const CATS = {
        Expense: {
            "Home Use": ["Monthly House Expense", "Mother", "Father", "Utilities (Water/Elec)", "Furniture/Hardware"],
            "Foods & Beverages": ["Breakfast", "Lunch", "Dinner", "Snack", "Bakery Item", "Drinks", "Grocery"],
            "Transportation": ["Fuel", "Service & Repairs", "Legal (Insurance/Rev)", "Commuting (Bus/Train)", "Parking"],
            "Telecommunication": ["Mobile Reload", "Internet/Data Bundle", "Cable TV"],
            "Healthcare": ["Medicine", "Doctor Visit", "Supplement", "Hospital Bill"],
            "Debt & Finance": ["Loan Repayment", "Credit Card Interest", "Pawn Interest", "Bank Charges"]
        },
        Income: {
            "Salary": ["Monthly Base", "Overtime", "Bonus"],
            "Freelance": ["Web Development", "Consulting"],
            "Claims & Refunds": ["Broadband Claim", "Medical Refund"],
            "Gifts": ["Personal", "Foreign Transaction"]
        }
    };

    async function load() {
        const { data: c } = await supa.from('Config').select('*').single();
        const { data: t } = await supa.from('Transaction').select('*').order('Date', { ascending: false });
        const { data: v } = await supa.from('Vehicles').select('*');
        conf = c; txs = t || []; vehs = v || [];
        calculate();
        if(document.getElementById('stats').classList.contains('active')) { runAnalysis(); runReport(); }
    }

    function calculate() {
        bal = { Main: conf.Main, Saving: conf.Saving, Crypto: conf.Crypto, "Credit Card": (conf.CCL - conf.CCS) };
        txs.forEach(t => {
            if(t.Category === "Transfer") return;
            if(t.Type === "Income") bal[t.Account] += +t.Amount; else bal[t.Account] -= +t.Amount;
        });

        const net = bal.Main + bal.Saving + (bal.Crypto * conf.Rate);
        document.getElementById('netVal').innerText = net.toLocaleString();
        document.getElementById('vMain').innerText = bal.Main.toLocaleString();
        document.getElementById('vSave').innerText = bal.Saving.toLocaleString();

        // Pie Chart Logic
        const curM = new Date().toISOString().slice(0, 7);
        const curTxs = txs.filter(t => t.Date.startsWith(curM) && t.Type === "Expense");
        const cMap = {};
        curTxs.forEach(t => cMap[t.Category] = (cMap[t.Category] || 0) + t.Amount);
        
        const sorted = Object.entries(cMap).sort((a,b) => b[1] - a[1]);
        const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
        let cum = 0, grad = [];
        sorted.forEach((e, i) => {
            const p = (e[1] / curTxs.reduce((a,b)=>a+b.Amount,0)) * 100;
            grad.push(`${colors[i%colors.length]} ${cum}% ${cum+p}%`);
            cum += p;
        });
        document.getElementById('pieChart').style.background = sorted.length ? `conic-gradient(${grad.join(',')})` : '#334155';

        document.getElementById('recentList').innerHTML = txs.slice(0, 5).map(t => `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid var(--border);">
                <div><b>${t.Subcategory}</b><br><small>${t.Date} ‚Ä¢ ${t.Account}</small></div>
                <div style="text-align:right">
                    <div style="color:${t.Type==='Income'?'var(--income)':'var(--expense)'}; font-weight:800;">${t.Amount.toLocaleString()}</div>
                    <button onclick="delTx('${t.id}')" class="btn-del">√ó</button>
                </div>
            </div>
        `).join('');
    }

    async function saveTx() {
        const amt = +document.getElementById('eAmt').value;
        const acc = document.getElementById('eAcc').value;
        if(amt <= 0) return msg("Invalid Amount");
        if(document.getElementById('eType').value === "Expense" && bal[acc] < amt) return msg("Insufficient Funds!");

        let rem = document.getElementById('eRem').value;
        if(document.getElementById('eCat').value === "Transportation") rem = `[${document.getElementById('eVeh').value}] ${rem}`;

        const { error } = await supa.from('Transaction').insert({
            Date: document.getElementById('eDate').value,
            Type: document.getElementById('eType').value,
            Category: document.getElementById('eCat').value,
            Subcategory: document.getElementById('eSub').value,
            Amount: amt,
            Account: acc,
            Remark: rem
        });
        if(!error) { msg("Saved"); clearForms(); load(); nav('dash'); }
    }

    async function doTransfer() {
        const amt = +document.getElementById('tAmt').value;
        const from = document.getElementById('tFrom').value;
        const to = document.getElementById('tTo').value;
        if(amt <= 0 || from === to || bal[from] < amt) return msg("Invalid Transfer");

        const { error } = await supa.from('Transaction').insert([
            { Date: document.getElementById('tDate').value, Type: "Expense", Category: "Transfer", Subcategory: "Out", Amount: amt, Account: from, Remark: "To " + to },
            { Date: document.getElementById('tDate').value, Type: "Income", Category: "Transfer", Subcategory: "In", Amount: amt, Account: to, Remark: "From " + from }
        ]);
        if(!error) { msg("Transfer Success"); clearForms(); load(); nav('dash'); }
    }

    function runAnalysis() {
        const curM = new Date().toISOString().slice(0, 7);
        const mE = txs.filter(t => t.Date.startsWith(curM) && t.Type === "Expense").reduce((a,b)=>a+b.Amount, 0);
        const days = new Date(new Date().getFullYear(), new Date().getMonth()+1, 0).getDate();
        const left = days - new Date().getDate();
        const daily = mE / new Date().getDate();
        document.getElementById('forecastBox').innerHTML = `
            <div style="display:flex; justify-content:space-between;">
                <div><small>EOM Forecast</small><br><b>LKR ${(daily * days).toLocaleString(undefined,{maximumFractionDigits:0})}</b></div>
                <div style="text-align:right"><small>Days Remaining</small><br><b>${left}</b></div>
            </div>`;
    }

    function nav(id, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        if(btn) btn.classList.add('active');
        document.getElementById('vTitle').innerText = id.charAt(0).toUpperCase() + id.slice(1);
        if(id === 'entry') { document.getElementById('eDate').valueAsDate = new Date(); loadCats(); updateLive('eAcc','eLive'); }
        if(id === 'transfer') { document.getElementById('tDate').valueAsDate = new Date(); updateLive('tFrom','tLive'); }
        if(id === 'stats') { runAnalysis(); runReport(); }
    }

    function loadCats() {
        const t = document.getElementById('eType').value;
        document.getElementById('eCat').innerHTML = Object.keys(CATS[t]).map(c => `<option>${c}</option>`).join('');
        loadSubs();
    }

    function loadSubs() {
        const t = document.getElementById('eType').value;
        const c = document.getElementById('eCat').value;
        document.getElementById('eSub').innerHTML = CATS[t][c].map(s => `<option>${s}</option>`).join('');
        document.getElementById('vehBox').style.display = (c === "Transportation") ? 'block' : 'none';
        document.getElementById('eVeh').innerHTML = vehs.map(v => `<option>${v.Registration}</option>`).join('');
    }

    function updateLive(sel, disp) {
        const acc = document.getElementById(sel).value;
        const amt = bal[acc] || 0;
        document.getElementById(disp).innerText = `LKR ${amt.toLocaleString()}`;
        document.getElementById(disp).style.color = amt <= 0 ? 'var(--expense)' : 'var(--primary)';
    }

    function toggleTheme() {
        const root = document.documentElement;
        root.setAttribute('data-theme', root.getAttribute('data-theme') === 'light' ? 'dark' : 'light');
    }

    function msg(m) {
        const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block';
        setTimeout(()=>t.style.display='none', 2500);
    }

    function clearForms() {
        ['eAmt', 'eRem', 'tAmt'].forEach(id => document.getElementById(id).value = '');
    }

    load();
</script>
</body>
</html>
